<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Chatbot</title>
  <style>
    :root {
      --bg: #f2f2f2;
      --text: #222;
      --card: #fff;
      --highlight: #1a73e8;
      --bot-bg: #f9f9f9;
    }
    body.dark {
      --bg: #121212;
      --text: #e0e0e0;
      --card: #1e1e1e;
      --bot-bg: #2a2a2a;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 40px;
      transition: 0.3s;
    }
    #chatbox {
      max-width: 700px;
      margin: auto;
      background: var(--card);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .msg {
      margin-bottom: 20px;
      position: relative;
    }
    .user {
      font-weight: bold;
      color: var(--highlight);
    }
    .bot {
      background-color: var(--bot-bg);
      border-left: 4px solid var(--highlight);
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    textarea, button, select {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .copy-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 0.8em;
      background: var(--highlight);
      color: white;
      border: none;
      border-radius: 3px;
      padding: 3px 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="chatbox">
    <h2>üí¨ Gemini Chatbot</h2>
    <div id="messages"></div>

    <textarea id="prompt" placeholder="Nh·∫≠p c√¢u h·ªèi... (Enter: g·ª≠i, Shift+Enter: xu·ªëng d√≤ng)"></textarea>
    <select id="model">
      <option value="gemini-2.0-flash">gemini-2.0-flash</option>
      <option value="gemini-2.0-pro">gemini-2.0-pro</option>
      <option value="gemini-1.5-pro">gemini-1.5-pro</option>
    </select>
    <input type="file" id="fileInput" multiple accept=".png,.jpg,.jpeg,.webp,.pdf,.txt,.doc,.docx,.xlsx,.zip" />

    <div id="controls">
      <button onclick="sendMessage()">G·ª≠i</button>
      <button onclick="resetChat()">üîÑ Reset</button>
      <button onclick="toggleDarkMode()">üåÉ Dark Mode</button>
      <button onclick="exportChat()">üìÑ Xu·∫•t File</button>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById("messages");
const promptInput = document.getElementById("prompt");
const fileInput = document.getElementById("fileInput");
const localKey = "chat_history";
let history = [];

window.onload = () => {
  const saved = localStorage.getItem(localKey);
  if (saved) {
    const parsed = JSON.parse(saved);
    parsed.forEach(msg => {
      addMessage(msg.sender, formatMarkdown(msg.text), true);
    });
    history = parsed
      .filter(m => m.sender === "You" || m.sender === "Bot")
      .map(m => ({
        role: m.sender === "You" ? "user" : "model",
        parts: [{ text: m.text }],
      }));
  }
  if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark");
  }
};

// Handle Enter to send, Shift+Enter to newline
promptInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

async function sendMessage() {
  const prompt = promptInput.value.trim();
  const model = document.getElementById("model").value;
  const files = Array.from(fileInput.files);

  if (!prompt && files.length === 0) return;

  addMessage("You", prompt || "[ƒê√£ g·ª≠i t·ªáp/·∫£nh]");
  promptInput.value = "";
  fileInput.value = "";

  const thinking = addMessage("Bot", "<em>ƒêang suy nghƒ©...</em>", true);

  // Convert all files to base64
  const encodedFiles = await Promise.all(
    files.map(file => toBase64(file).then(data => ({
      data,
      mimeType: file.type,
      name: file.name,
    })))
  );

  try {
    const res = await fetch("/api/gemini", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, model, history, files: encodedFiles }),
    });

    const data = await res.json();
    const reply = data.reply || "Kh√¥ng c√≥ ph·∫£n h·ªìi.";
    updateMessage(thinking, formatMarkdown(reply));

    history.push({ role: "user", parts: [{ text: prompt }] });
    history.push({ role: "model", parts: [{ text: reply }] });

    saveToLocal();
  } catch (err) {
    updateMessage(thinking, "‚ùå L·ªói khi g·ªçi API.");
  }
}

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(",")[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function addMessage(sender, text, isHTML = false) {
  const msgDiv = document.createElement("div");
  msgDiv.className = "msg";

  const avatar = document.createElement("span");
  avatar.style.fontSize = "1.5em";
  avatar.style.marginRight = "8px";
  avatar.textContent = sender === "You" ? "üßë" : "ü§ñ";

  const senderSpan = document.createElement("div");
  senderSpan.className = "user";
  senderSpan.textContent = `${sender}:`;

  const contentDiv = document.createElement("div");
  contentDiv.className = "bot";
  contentDiv.innerHTML = isHTML ? text : escapeHTML(text);

  // Detect image URLs and append preview
  if (sender === "You" && fileInput.files.length > 0) {
    Array.from(fileInput.files).forEach(file => {
      if (file.type.startsWith("image/")) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.maxWidth = "100%";
        img.style.marginTop = "10px";
        contentDiv.appendChild(img);
      }
    });
  }

  if (sender === "Bot") {
    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "üìã Copy";
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(contentDiv.textContent);
      copyBtn.textContent = "‚úÖ Copied!";
      setTimeout(() => (copyBtn.textContent = "üìã Copy"), 1500);
    };
    msgDiv.appendChild(copyBtn);
  }

  msgDiv.appendChild(avatar);
  msgDiv.appendChild(senderSpan);
  msgDiv.appendChild(contentDiv);
  messagesDiv.appendChild(msgDiv);

  window.scrollTo(0, document.body.scrollHeight);
  return contentDiv;
}

function updateMessage(node, newText) {
  node.innerHTML = newText;
  window.scrollTo(0, document.body.scrollHeight);
}

function resetChat() {
  messagesDiv.innerHTML = "";
  history = [];
  localStorage.removeItem(localKey);
}

function toggleDarkMode() {
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
}

function formatMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.*?)\*/g, "<em>$1</em>")
    .replace(/`([^`]+)`/g, "<code>$1</code>")
    .replace(/\n/g, "<br>");
}

function escapeHTML(str) {
  return str.replace(/[&<>'"]/g, tag => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;',
    "'": '&#39;', '"': '&quot;',
  }[tag]));
}

function saveToLocal() {
  const saved = history.map(h => ({
    sender: h.role === "user" ? "You" : "Bot",
    text: h.parts[0].text
  }));
  localStorage.setItem(localKey, JSON.stringify(saved));
}

function exportChat() {
  const saved = localStorage.getItem(localKey);
  if (!saved) return alert("Kh√¥ng c√≥ h·ªôi tho·∫°i ƒë·ªÉ xu·∫•t.");
  const messages = JSON.parse(saved);
  const lines = messages.map(m => `${m.sender}: ${m.text}`).join("\n\n");
  const blob = new Blob([lines], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

  </script>
</body>
</html>
